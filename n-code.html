<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>N-Code</title>
  <meta name="theme-color" content="#111111" />
  <style>
    :root{--bg:#0f0f10;--card:#17171a;--text:#f2f2f2;--muted:#b6b6b6;--line:#2a2a2f;--ok:#1ad17a;--warn:#ffb020}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:18px 16px 12px;position:sticky;top:0;background:linear-gradient(#0f0f10 85%, rgba(15,15,16,0));backdrop-filter: blur(6px)}
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
    main{padding:12px 16px 100px;max-width:960px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.22)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted)}
    input, textarea, select, button{
      font-size:16px;border-radius:14px;border:1px solid var(--line);
      background:#0f0f10;color:var(--text);padding:10px 12px;outline:none
    }
    textarea{width:100%;min-height:140px;resize:vertical}
    select{padding-right:34px}
    button{border:0;cursor:pointer;background:#232329}
    button.primary{background:#2c2c36}
    button.good{background:rgba(26,209,122,.15);border:1px solid rgba(26,209,122,.35)}
    button.warn{background:rgba(255,176,32,.12);border:1px solid rgba(255,176,32,.35)}
    button:active{transform:scale(.99)}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .status{margin-top:10px;font-size:13px;line-height:1.4;color:var(--muted)}
    .status .ok{color:var(--ok)}
    .status .warn{color:var(--warn)}
    .split{display:grid;gap:12px}
    @media (min-width:860px){.split{grid-template-columns:1fr 1fr}}
    footer{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 16px;background:rgba(15,15,16,.92);border-top:1px solid var(--line);backdrop-filter: blur(10px)
    }
    .footer-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;max-width:960px;margin:0 auto}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{width:min(820px,100%);background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
    .modal h2{margin:0 0 10px 0;font-size:16px}
    .grid2{display:grid;gap:12px}
    @media (min-width:860px){.grid2{grid-template-columns:1.2fr 1fr}}
    video{width:100%;border-radius:16px;border:1px solid var(--line);background:#000}
    canvas{background:#fff;border-radius:16px;border:1px solid var(--line);width:100%;max-width:360px;height:auto}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <h1>N-Code üîê</h1>
  <div class="sub">
    Szyfruje te≈º spacje/znaki. Ma QR generator + QR skaner kamerƒÖ. Auto-parowanie: skanujesz i klucz ustawia siƒô sam.
  </div>
</header>

<main>
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="pill">Szyfruje spacje ‚úÖ</span>
        <span class="pill">QR: generuj + skanuj ‚úÖ</span>
        <span class="pill">Auto-parowanie ‚úÖ</span>
      </div>
      <div class="row">
        <span class="pill">Mod: <span class="mono" id="modN"></span></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label for="key"><b>Klucz</b> (zapamiƒôtywany)</label><br>
        <input id="key" value="NIUNIA" placeholder="np. NIUNIA" />
      </div>

      <div>
        <label for="mode"><b>Tryb</b></label><br>
        <select id="mode">
          <option value="enc">Koduj</option>
          <option value="dec">Odkoduj</option>
        </select>
      </div>

      <div>
        <label for="keyLen"><b>Losuj klucz</b></label><br>
        <div class="row">
          <input id="keyLen" type="number" min="4" max="64" value="12" style="width:110px" />
          <button class="warn" id="randKey">Losuj</button>
        </div>
      </div>

      <div>
        <label><b>QR</b></label><br>
        <div class="row">
          <button class="primary" id="openQR">Poka≈º QR klucza</button>
          <button class="primary" id="openScan">Skanuj QR</button>
          <button class="primary" id="sharePayload">Wy≈õlij tekst QR</button>
        </div>
      </div>

      <div>
        <label><b>Narzƒôdzia</b></label><br>
        <div class="row">
          <button class="primary" id="swap">Zamie≈Ñ pola ‚áÖ</button>
          <button class="primary" id="copyOut">Kopiuj wynik</button>
        </div>
      </div>
    </div>

    <div class="status" id="status"></div>
  </div>

  <div class="split">
    <div class="card">
      <b>Tekst wej≈õciowy</b>
      <textarea id="input" placeholder="Wpisz wiadomo≈õƒá‚Ä¶">CZE≈öƒÜ KRAWCU!</textarea>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <button class="good" id="run">Wykonaj</button>
        <button class="primary" id="clearIn">Wyczy≈õƒá wej≈õcie</button>
      </div>
    </div>

    <div class="card">
      <b>Wynik</b>
      <textarea id="output" placeholder="Tu pojawi siƒô wynik‚Ä¶" readonly></textarea>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <button class="primary" id="clearOut">Wyczy≈õƒá wynik</button>
      </div>
    </div>
  </div>
</main>

<footer>
  <div class="footer-row">
    <div class="row">
      <span class="pill mono">Payload: N-CODE;...;KEY=</span>
    </div>
    <div class="row">
      <span class="pill">Tip: poka≈º QR na drugim telefonie/monitorze i skanuj. Klik i wracasz do Breakpointa üòà</span>
    </div>
  </div>
</footer>

<!-- QR Modal -->
<div class="modal-backdrop" id="qrModal">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>QR klucza</h2>
      <button class="primary" id="closeQR">Zamknij</button>
    </div>

    <div class="grid2">
      <div>
        <canvas id="qrcanvas" width="360" height="360"></canvas>
        <div class="muted" style="margin-top:10px">
          Kolega skanuje i ma ten sam klucz. Albo Ty skanujesz jego QR w drugƒÖ stronƒô.
        </div>
      </div>
      <div>
        <div class="muted">Tekst QR (do wys≈Çania):</div>
        <textarea id="qrtext" class="mono" style="min-height:200px" readonly></textarea>
        <div class="row" style="margin-top:10px">
          <button class="primary" id="copyQRText">Kopiuj tekst</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scan Modal -->
<div class="modal-backdrop" id="scanModal">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Skaner QR</h2>
      <div class="row">
        <button class="primary" id="toggleCam">Start</button>
        <button class="primary" id="closeScan">Zamknij</button>
      </div>
    </div>

    <div class="grid2">
      <div>
        <video id="video" playsinline></video>
        <div class="muted" id="scanHint" style="margin-top:10px">
          Nakieruj kamerƒô na QR z kluczem.
        </div>
        <div class="muted" style="margin-top:6px">
          Je≈õli brak kamery: k≈Ç√≥dka przy adresie ‚Üí uprawnienia ‚Üí Kamera: Zezw√≥l.
        </div>
      </div>

      <div>
        <div class="card" style="margin:0">
          <b>Odczyt</b>
          <textarea id="scanOut" class="mono" style="min-height:200px" readonly></textarea>

          <div class="row" style="margin-top:10px;justify-content:space-between">
            <label class="muted" style="display:flex;align-items:center;gap:10px">
              <input type="checkbox" id="autoApply" checked style="width:20px;height:20px" />
              Auto-parowanie (ustaw klucz po skanie)
            </label>
          </div>

          <div class="row" style="margin-top:10px;justify-content:space-between">
            <button class="good" id="applyKey">Ustaw klucz</button>
            <button class="primary" id="copyScan">Kopiuj</button>
          </div>
          <div class="muted" style="margin-top:10px">
            Apka wyciƒÖga klucz z pola <span class="mono">KEY=</span>.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const ALPH = [
    "A","ƒÑ","B","C","ƒÜ","D","E","ƒò","F","G","H","I","J","K","L","≈Å","M","N","≈É","O","√ì","P","Q","R","S","≈ö","T","U","V","W","X","Y","Z","≈π","≈ª",
    " ", ".", ",", "!", "?", ":", ";", "-", "_", "@", "#", "(", ")", "[", "]", "{", "}", "/", "\\", "\"","'",
    "0","1","2","3","4","5","6","7","8","9"
  ];
  const N = ALPH.length;
  const idx = new Map(ALPH.map((ch,i)=>[ch,i]));
  const KEY_ALPH = ["A","ƒÑ","B","C","ƒÜ","D","E","ƒò","F","G","H","I","J","K","L","≈Å","M","N","≈É","O","√ì","P","Q","R","S","≈ö","T","U","V","W","X","Y","Z","≈π","≈ª"];

  const $ = (id) => document.getElementById(id);
  const els = {
    key: $("key"), mode: $("mode"), input: $("input"), output: $("output"),
    status: $("status"), run: $("run"), swap: $("swap"), copyOut: $("copyOut"),
    clearIn: $("clearIn"), clearOut: $("clearOut"), keyLen: $("keyLen"), randKey: $("randKey"),
    modN: $("modN"),
    openQR: $("openQR"), qrModal: $("qrModal"), closeQR: $("closeQR"), qrcanvas: $("qrcanvas"),
    qrtext: $("qrtext"), copyQRText: $("copyQRText"),
    openScan: $("openScan"), scanModal: $("scanModal"), closeScan: $("closeScan"), toggleCam: $("toggleCam"),
    video: $("video"), scanOut: $("scanOut"), applyKey: $("applyKey"), copyScan: $("copyScan"), scanHint: $("scanHint"),
    autoApply: $("autoApply"),
    sharePayload: $("sharePayload")
  };

  const LS_KEY = "ncode_key_v3_auto_pair";

  const normalize = (s) => (s ?? "").toUpperCase().replace(/\u00A0/g, " ");
  const cleanToAlphabet = (s) => [...normalize(s)].filter(ch => idx.has(ch)).join("");
  const cleanKey = (k) => cleanToAlphabet(k).replace(/ /g, "");

  const setStatus = (html) => els.status.innerHTML = html;

  const transform = (text, key, decrypt=false) => {
    const t = normalize(text);
    const k = cleanKey(key);
    if (!k.length) return { out:"", warnings:["Klucz po filtracji jest pusty."], keyUsed:"" };
    let out="", ki=0, unknown=0;
    for (const ch of t){
      if(!idx.has(ch)){ out+=ch; unknown++; continue; }
      const a = idx.get(ch);
      const b = idx.get(k[ki % k.length]);
      const v = decrypt ? (a - b + N) % N : (a + b) % N;
      out += ALPH[v];
      ki++;
    }
    const warnings=[];
    if(unknown) warnings.push(`Pozostawiono ${unknown} znak(√≥w) spoza alfabetu.`);
    return { out, warnings, keyUsed:k };
  };

  const run = () => {
    localStorage.setItem(LS_KEY, els.key.value);
    const { out, warnings, keyUsed } = transform(els.input.value, els.key.value, els.mode.value==="dec");
    els.output.value = out;
    setStatus([`<span class="ok">OK</span> ‚Ä¢ klucz: <span class="mono">${keyUsed}</span> ‚Ä¢ mod <span class="mono">${N}</span>`,
      ...warnings.map(w=>`<span class="warn">${w}</span>`)
    ].join("<br>"));
  };

  const swap = () => { const a=els.input.value; els.input.value=els.output.value; els.output.value=a; run(); };

  const copyOut = async () => {
    try{ await navigator.clipboard.writeText(els.output.value); setStatus(`<span class="ok">Skopiowane.</span>`); }
    catch{ setStatus(`<span class="warn">Nie mogƒô skopiowaƒá automatycznie. Skopiuj rƒôcznie.</span>`); }
  };

  const randKey = () => {
    const len = Math.max(4, Math.min(64, Number(els.keyLen.value) || 12));
    const buf = new Uint32Array(len);
    crypto.getRandomValues(buf);
    let k="";
    for(let i=0;i<len;i++) k += KEY_ALPH[buf[i] % KEY_ALPH.length];
    els.key.value = k;
    run();
  };

  const alphaSig = () => `${ALPH.slice(0,10).join("")}|${ALPH.slice(-10).join("")}`;
  const makePayload = () => `N-CODE;V=1;MOD=${N};ALPHA=${alphaSig()};KEY=${cleanKey(els.key.value)}`;

  // ---------- Tiny QR generator (same as earlier build, trimmed) ----------
  class BitBuffer{constructor(){this.data=[];this.bitLength=0;}appendBits(v,l){for(let i=l-1;i>=0;i--){this.data.push(((v>>>i)&1)!==0);this.bitLength++;}}appendData(bb){for(let i=0;i<bb.bitLength;i++)this.appendBits(bb.getBits(i,1),1);}getBits(i,l){let v=0;for(let j=0;j<l;j++)v=(v<<1)|(this.data[i+j]?1:0);return v;}}
  class QrSegment{static makeBytes(bytes){const bb=new BitBuffer();for(const b of bytes)bb.appendBits(b,8);return {mode:0b0100,numChars:bytes.length,data:bb};}}
  class QrCode{
    static Ecc={LOW:0,MEDIUM:1,QUARTILE:2,HIGH:3};
    static encodeText(text,ecl){const seg=QrSegment.makeBytes(new TextEncoder().encode(text));return QrCode.encodeSegments([seg],ecl);}
    static getNumDataCodewords(ver,ecl){
      const L=[0,19,34,55,80,108,136,156,194,232,274];
      const M=[0,16,28,44,64,86,108,124,154,182,216];
      const Q=[0,13,22,34,48,62,76,88,110,132,154];
      const H=[0,9,16,26,36,46,60,66,86,100,122];
      const t=ecl===0?L:ecl===1?M:ecl===2?Q:H; return t[ver];
    }
    static getNumEccCodewords(ver,ecl){
      const L=[0,7,10,15,20,26,36,40,48,60,72];
      const M=[0,10,16,26,36,48,64,72,88,110,130];
      const Q=[0,13,22,18,26,36,40,48,60,72,80];
      const H=[0,17,28,22,28,40,44,52,64,72,88];
      const t=ecl===0?L:ecl===1?M:ecl===2?Q:H; return t[ver];
    }
    static getFormatBits(ecl,mask){
      const eclBits=[1,0,3,2][ecl];
      let data=(eclBits<<3)|mask;
      let rem=data<<10;
      const poly=0b10100110111;
      for(let i=14;i>=10;i--) if(((rem>>>i)&1)!==0) rem ^= poly<<(i-10);
      return (((data<<10)|rem) ^ 0b101010000010010) >>> 0;
    }
    static reedSolomonExp(i){let x=1;for(let k=0;k<i;k++){x<<=1;if(x&0x100)x^=0x11D;}return x;}
    static reedSolomonLog(x){let y=1;for(let i=0;i<255;i++){if(y===x)return i;y=QrCode.reedSolomonMultiply(y,2);}throw new Error("log");}
    static reedSolomonLogExp(i){while(i<0)i+=255;while(i>=255)i-=255;return QrCode.reedSolomonExp(i);}
    static reedSolomonMultiply(x,y){if(x===0||y===0)return 0;return QrCode.reedSolomonLogExp(QrCode.reedSolomonLog(x)+QrCode.reedSolomonLog(y));}
    static reedSolomonMultiplyPoly(p,q){const r=Array(p.length+q.length-1).fill(0);for(let i=0;i<p.length;i++)for(let j=0;j<q.length;j++)r[i+j]^=QrCode.reedSolomonMultiply(p[i],q[j]);return r;}
    static reedSolomonComputeDivisor(deg){let r=[1];for(let i=0;i<deg;i++)r=QrCode.reedSolomonMultiplyPoly(r,[1,QrCode.reedSolomonExp(i)]);return r;}
    static reedSolomonComputeRemainder(data,div){let r=Array(div.length-1).fill(0);for(const b of data){const factor=b^r[0];r.shift();r.push(0);for(let i=0;i<r.length;i++)r[i]^=QrCode.reedSolomonMultiply(div[i],factor);}return r;}
    static encodeSegments(segs,ecl){
      let version;
      for(version=1;version<=10;version++){
        const cap=QrCode.getNumDataCodewords(version,ecl)*8;
        const bb=new BitBuffer();
        for(const s of segs){
          bb.appendBits(s.mode,4);
          bb.appendBits(s.numChars, version<=9?8:16);
          bb.appendData(s.data);
        }
        if(bb.bitLength<=cap) break;
      }
      if(version>10) throw new Error("Tekst zbyt d≈Çugi do QR (v1..10).");
      const cap=QrCode.getNumDataCodewords(version,ecl)*8;
      const bb=new BitBuffer();
      for(const s of segs){ bb.appendBits(s.mode,4); bb.appendBits(s.numChars, version<=9?8:16); bb.appendData(s.data); }
      bb.appendBits(0, Math.min(4, cap-bb.bitLength));
      bb.appendBits(0, (8 - bb.bitLength%8)%8);
      for(let toggle=0; bb.bitLength<cap; toggle^=1) bb.appendBits(toggle?0x11:0xEC,8);
      const data=[];
      for(let i=0;i<bb.bitLength;i+=8) data.push(bb.getBits(i,8));
      const eccCount=QrCode.getNumEccCodewords(version,ecl);
      const div=QrCode.reedSolomonComputeDivisor(eccCount);
      const ecc=QrCode.reedSolomonComputeRemainder(data,div);
      const codewords=data.concat(ecc);

      const size=version*4+17;
      const modules=Array.from({length:size},()=>Array(size).fill(false));
      const isFunc=Array.from({length:size},()=>Array(size).fill(false));
      const setF=(x,y,v)=>{modules[y][x]=v;isFunc[y][x]=true;};

      const finder=(x,y)=>{
        for(let dy=-4;dy<=4;dy++)for(let dx=-4;dx<=4;dx++){
          const xx=x+dx, yy=y+dy;
          if(xx<0||yy<0||xx>=size||yy>=size) continue;
          const dist=Math.max(Math.abs(dx),Math.abs(dy));
          setF(xx,yy,dist!==2 && dist!==4);
        }
      };
      finder(3,3); finder(size-4,3); finder(3,size-4);
      for(let i=0;i<size;i++){
        if(!isFunc[6][i]) setF(i,6,i%2===0);
        if(!isFunc[i][6]) setF(6,i,i%2===0);
      }
      setF(8,size-8,true);
      for(let i=0;i<9;i++){isFunc[8][i]=true;isFunc[i][8]=true;}
      for(let i=size-8;i<size;i++){isFunc[8][i]=true;isFunc[i][8]=true;}

      let bit=0, dir=-1;
      for(let x=size-1;x>=1;x-=2){
        if(x===6) x--;
        for(let y=0;y<size;y++){
          const yy=dir===1?y:(size-1-y);
          for(let k=0;k<2;k++){
            const xx=x-k;
            if(isFunc[yy][xx]) continue;
            const b=codewords[Math.floor(bit/8)];
            const v=((b >>> (7-(bit%8))) & 1) !== 0;
            const masked = v ^ (((yy+xx)%2)===0); // mask 0
            modules[yy][xx]=masked;
            bit++;
          }
        }
        dir=-dir;
      }
      const fmt=QrCode.getFormatBits(ecl,0);
      const putFmt=(i,fn)=>fn(((fmt>>>i)&1)!==0);
      for(let i=0;i<=5;i++) putFmt(i, b=>setF(8,i,b));
      putFmt(6, b=>setF(8,7,b));
      putFmt(7, b=>setF(8,8,b));
      putFmt(8, b=>setF(7,8,b));
      for(let i=9;i<15;i++) putFmt(i, b=>setF(14-i,8,b));
      for(let i=0;i<8;i++) putFmt(i, b=>setF(size-1-i,8,b));
      for(let i=8;i<15;i++) putFmt(i, b=>setF(8,size-15+i,b));
      return {size, modules};
    }
  }
  const drawQR = (text) => {
    const qr = QrCode.encodeText(text, QrCode.Ecc.MEDIUM);
    const canvas = els.qrcanvas;
    const ctx = canvas.getContext("2d");
    const border = 4;
    const size = qr.size + border*2;
    const scale = Math.floor(Math.min(canvas.width, canvas.height) / size);
    const drawSize = size * scale;
    const ox = Math.floor((canvas.width - drawSize)/2);
    const oy = Math.floor((canvas.height - drawSize)/2);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#000";
    for(let y=0;y<size;y++){
      for(let x=0;x<size;x++){
        const xx=x-border, yy=y-border;
        const dark = (xx>=0 && yy>=0 && xx<qr.size && yy<qr.size) ? qr.modules[yy][xx] : false;
        if(dark) ctx.fillRect(ox+x*scale, oy+y*scale, scale, scale);
      }
    }
  };

  const openQR = () => {
    const payload = makePayload();
    els.qrtext.value = payload;
    drawQR(payload);
    els.qrModal.style.display="flex";
  };
  const closeQR = () => els.qrModal.style.display="none";
  const copyQRText = async () => {
    try{ await navigator.clipboard.writeText(els.qrtext.value); setStatus(`<span class="ok">Skopiowa≈Çam tekst QR.</span>`); }
    catch{ setStatus(`<span class="warn">Nie mogƒô skopiowaƒá. Skopiuj rƒôcznie.</span>`); }
  };
  const sharePayload = async () => {
    const payload = makePayload();
    if(navigator.share){
      try{ await navigator.share({title:"N-Code key", text: payload}); setStatus(`<span class="ok">Wys≈Çane.</span>`); return; }
      catch{}
    }
    try{ await navigator.clipboard.writeText(payload); setStatus(`<span class="ok">Skopiowane do schowka.</span>`); }
    catch{ els.output.value = payload; setStatus(`<span class="warn">Wrzuci≈Çam payload do pola Wynik.</span>`); }
  };

  // Scanner
  let stream=null, scanning=false, detector=null, rafId=null;
  const supportsDetector = () => ("BarcodeDetector" in window);

  const stopCam = async () => {
    scanning=false;
    if(rafId) cancelAnimationFrame(rafId);
    rafId=null;
    if(stream){ for(const t of stream.getTracks()) t.stop(); stream=null; }
    els.video.srcObject=null;
    els.toggleCam.textContent="Start";
  };

  const parseKey = (text) => {
    const m = (text||"").trim().match(/(^|;)KEY=([^;]+)/i);
    return m ? m[2].trim() : null;
  };

  const applyKeyFromString = async (kstr, auto=false) => {
    const filtered = cleanKey(kstr);
    if(!filtered.length){
      setStatus(`<span class="warn">Klucz z QR po filtracji pusty.</span>`);
      return false;
    }
    els.key.value = filtered;
    localStorage.setItem(LS_KEY, els.key.value);
    setStatus(`<span class="ok">${auto ? "Sparowano" : "Klucz ustawiony"}.</span>`);
    run();
    return true;
  };

  const loop = async () => {
    if(!scanning || !detector) return;
    try{
      const codes = await detector.detect(els.video);
      if(codes && codes.length){
        const raw = codes[0].rawValue || "";
        els.scanOut.value = raw;

        const k = parseKey(raw);
        if (k) {
          els.scanHint.innerHTML = `<span class="ok">Wykryto N-Code.</span> ${els.autoApply?.checked ? "Parujƒô‚Ä¶" : "Kliknij ‚ÄûUstaw klucz‚Äù."}`;
          if (els.autoApply?.checked) {
            const ok = await applyKeyFromString(k, true);
            await stopCam();
            if (ok) els.scanModal.style.display = "none";
            return;
          }
        } else {
          els.scanHint.innerHTML = `Wykryto QR, ale brak <span class="mono">KEY=</span>.`;
        }

        await stopCam();
        return;
      }
    }catch{}
    rafId = requestAnimationFrame(loop);
  };

  const startCam = async () => {
    if(!supportsDetector()){
      els.scanHint.innerHTML = `Brak <span class="mono">BarcodeDetector</span>. U≈ºyj Chrome.`;
      setStatus(`<span class="warn">Skaner wymaga BarcodeDetector.</span>`);
      return;
    }
    detector = new BarcodeDetector({formats:["qr_code"]});
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:false});
      els.video.srcObject = stream;
      await els.video.play();
      scanning=true;
      els.toggleCam.textContent="Stop";
      loop();
    }catch(e){
      setStatus(`<span class="warn">Kamera nie ruszy≈Ça:</span> ${String(e.message||e)}`);
      els.scanHint.innerHTML = `Sprawd≈∫ uprawnienia kamery dla tej witryny.`;
    }
  };

  const openScan = async () => {
    els.scanOut.value="";
    els.scanHint.textContent="Nakieruj kamerƒô na QR z kluczem.";
    els.scanModal.style.display="flex";
    if (!stream) await startCam();
  };

  const closeScan = async () => {
    await stopCam();
    els.scanModal.style.display="none";
  };

  const applyKey = async () => {
    const raw = els.scanOut.value || "";
    const k = parseKey(raw);
    if(!k){ setStatus(`<span class="warn">Brak KEY= w QR.</span>`); return; }
    await applyKeyFromString(k, false);
    els.scanModal.style.display="none";
  };

  const copyScan = async () => {
    try{ await navigator.clipboard.writeText(els.scanOut.value||""); setStatus(`<span class="ok">Skopiowane.</span>`); }
    catch{ setStatus(`<span class="warn">Nie mogƒô skopiowaƒá automatycznie.</span>`); }
  };

  // init & events
  els.modN.textContent = String(N);
  const saved = localStorage.getItem(LS_KEY);
  if(saved) els.key.value = saved;

  run();

  els.run.addEventListener("click", run);
  els.mode.addEventListener("change", run);
  els.key.addEventListener("input", () => localStorage.setItem(LS_KEY, els.key.value));
  els.swap.addEventListener("click", swap);
  els.copyOut.addEventListener("click", copyOut);
  els.clearIn.addEventListener("click", () => { els.input.value=""; run(); });
  els.clearOut.addEventListener("click", () => { els.output.value=""; setStatus(`<span class="ok">Wynik wyczyszczony.</span>`); });
  els.randKey.addEventListener("click", randKey);

  els.openQR.addEventListener("click", openQR);
  els.closeQR.addEventListener("click", closeQR);
  els.qrModal.addEventListener("click", (e)=>{ if(e.target===els.qrModal) closeQR(); });
  els.copyQRText.addEventListener("click", copyQRText);
  els.sharePayload.addEventListener("click", sharePayload);

  els.openScan.addEventListener("click", openScan);
  els.closeScan.addEventListener("click", closeScan);
  els.scanModal.addEventListener("click", (e)=>{ if(e.target===els.scanModal) closeScan(); });
  els.toggleCam.addEventListener("click", async ()=>{ if(stream) await stopCam(); else await startCam(); });
  els.applyKey.addEventListener("click", applyKey);
  els.copyScan.addEventListener("click", copyScan);

})();
</script>
</body>
</html>
